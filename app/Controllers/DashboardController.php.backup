<?php

namespace App\Controllers;

use App\Controllers\BaseController;
use App\Models\ProductModel;
use App\Models\BrandModel;
use App\Models\CategoryModel;

class DashboardController extends BaseController
{
    protected $db;
    protected $productModel;
    protected $brandModel;
    protected $categoryModel;

    public function __construct()
    {
        $this->db            = \Config\Database::connect();
        $this->productModel  = new ProductModel();
        $this->brandModel    = new BrandModel();
        $this->categoryModel = new CategoryModel();
        helper(['date']);
    }

    /**
     * Load dashboard shell and initial filter datasets
     */
    public function index()
    {
        $data = [
            'products'   => $this->productModel->orderBy('nama_barang', 'ASC')->findAll(),
            'brands'     => $this->brandModel->orderBy('nama_brand', 'ASC')->findAll(),
            'categories' => $this->categoryModel->orderBy('nama_kategori', 'ASC')->findAll(),
        ];

        return view('Dashboard/index', $data);
    }

    /**
     * Central AJAX endpoint to fetch all dashboard datasets in one call
     * POST params: startDate (Y-m-d), endDate (Y-m-d), productId, brandId, categoryId
     */
    public function fetchData()
    {
        $startDate  = (string) $this->request->getPost('startDate');
        $endDate    = (string) $this->request->getPost('endDate');
        $productId  = (string) $this->request->getPost('productId');
        $brandId    = (string) $this->request->getPost('brandId');
        $categoryId = (string) $this->request->getPost('categoryId');

        // Default last 30 days if not provided
        if (empty($startDate) || empty($endDate)) {
            $endDate   = date('Y-m-d');
            $startDate = date('Y-m-d', strtotime('-29 days'));
        }

        $startDT = $startDate . ' 00:00:00';
        $endDT   = $endDate . ' 23:59:59';

        // ------------- Helper closures for dynamic filters -------------
        $applyProductFilter = function ($builder, string $productAlias, bool $joinProductIfNeeded = false) use ($productId, $brandId, $categoryId) {
            if (!empty($productId)) {
                $builder->where("$productAlias.id", (int) $productId);
            }
            if (!empty($brandId)) {
                if ($joinProductIfNeeded) {
                    // assume we already joined as alias $productAlias
                    $builder->where("$productAlias.brand_id", (int) $brandId);
                } else {
                    $builder->where("$productAlias.brand_id", (int) $brandId);
                }
            }
            if (!empty($categoryId)) {
                if ($joinProductIfNeeded) {
                    $builder->where("$productAlias.category_id", (int) $categoryId);
                } else {
                    $builder->where("$productAlias.category_id", (int) $categoryId);
                }
            }
        };

        // ------------- Cards (totals) -------------
        // Total Masuk
        $bIn = $this->db->table('tb_stock_in_items sii')
            ->join('tb_stock_in si', 'si.id = sii.stock_in_id', 'inner');

        // join products if we need brand/category filter or specific product
        if (!empty($productId) || !empty($brandId) || !empty($categoryId)) {
            $bIn->join('tb_products p', 'p.id = sii.product_id', 'inner');
            $applyProductFilter($bIn, 'p', true);
        }

        $bIn->where('si.tanggal_masuk >=', $startDT)
            ->where('si.tanggal_masuk <=', $endDT)
            ->selectSum('sii.jumlah', 'total_masuk');

        $rowIn = $bIn->get()->getRowArray();
        $totalMasuk = (int) ($rowIn['total_masuk'] ?? 0);

        // Total Keluar
        $bOut = $this->db->table('tb_stock_out_items soi')
            ->join('tb_stock_out so', 'so.id = soi.stock_out_id', 'inner');

        if (!empty($productId) || !empty($brandId) || !empty($categoryId)) {
            $bOut->join('tb_products p', 'p.id = soi.product_id', 'inner');
            $applyProductFilter($bOut, 'p', true);
        }

        $bOut->where('so.tanggal_keluar >=', $startDT)
            ->where('so.tanggal_keluar <=', $endDT)
            ->selectSum('soi.jumlah', 'total_keluar');

        $rowOut = $bOut->get()->getRowArray();
        $totalKeluar = (int) ($rowOut['total_keluar'] ?? 0);

        // Total Stok (apply product/brand/category only)
        $bStock = $this->db->table('tb_products p')->selectSum('p.stok_saat_ini', 'total_stok');

        if (!empty($productId)) {
            $bStock->where('p.id', (int) $productId);
        }
        if (!empty($brandId)) {
            $bStock->where('p.brand_id', (int) $brandId);
        }
        if (!empty($categoryId)) {
            $bStock->where('p.category_id', (int) $categoryId);
        }

        $rowStock = $bStock->get()->getRowArray();
        $totalStok = (int) ($rowStock['total_stok'] ?? 0);

        $cards = [
            'total_masuk'  => $totalMasuk,
            'total_keluar' => $totalKeluar,
            'total_stok'   => $totalStok,
        ];

        // ------------- Overview Chart (group by date) -------------
        $bInDaily = $this->db->table('tb_stock_in si')
            ->join('tb_stock_in_items sii', 'sii.stock_in_id = si.id', 'inner')
            ->select("DATE(si.tanggal_masuk) AS tgl", false)
            ->select("SUM(sii.jumlah) AS total", false)
            ->where('si.tanggal_masuk >=', $startDT)
            ->where('si.tanggal_masuk <=', $endDT)
            ->groupBy('DATE(si.tanggal_masuk)');

        if (!empty($productId) || !empty($brandId) || !empty($categoryId)) {
            $bInDaily->join('tb_products p', 'p.id = sii.product_id', 'inner');
            $applyProductFilter($bInDaily, 'p', true);
        }

        $inDailyRows = $bInDaily->get()->getResultArray();
        $inDaily = [];
        foreach ($inDailyRows as $r) {
            $inDaily[$r['tgl']] = (int) $r['total'];
        }

        $bOutDaily = $this->db->table('tb_stock_out so')
            ->join('tb_stock_out_items soi', 'soi.stock_out_id = so.id', 'inner')
            ->select("DATE(so.tanggal_keluar) AS tgl", false)
            ->select("SUM(soi.jumlah) AS total", false)
            ->where('so.tanggal_keluar >=', $startDT)
            ->where('so.tanggal_keluar <=', $endDT)
            ->groupBy('DATE(so.tanggal_keluar)');

        if (!empty($productId) || !empty($brandId) || !empty($categoryId)) {
            $bOutDaily->join('tb_products p', 'p.id = soi.product_id', 'inner');
            $applyProductFilter($bOutDaily, 'p', true);
        }

        $outDailyRows = $bOutDaily->get()->getResultArray();
        $outDaily = [];
        foreach ($outDailyRows as $r) {
            $outDaily[$r['tgl']] = (int) $r['total'];
        }

        // Merge into continuous date series
        $overview = [];
        $period = new \DatePeriod(
            new \DateTime($startDate),
            new \DateInterval('P1D'),
            (new \DateTime($endDate))->modify('+1 day')
        );
        foreach ($period as $dt) {
            $d = $dt->format('Y-m-d');
            $overview[] = [
                'waktu'  => $d,
                'masuk'  => $inDaily[$d]  ?? 0,
                'keluar' => $outDaily[$d] ?? 0,
            ];
        }

        // ------------- Top Products (Stock Out) -------------
        $bTop = $this->db->table('tb_stock_out_items soi')
            ->join('tb_stock_out so', 'so.id = soi.stock_out_id', 'inner')
            ->join('tb_products p', 'p.id = soi.product_id', 'inner')
            ->select('p.nama_barang AS produk')
            ->select('SUM(soi.jumlah) AS total', false)
            ->where('so.tanggal_keluar >=', $startDT)
            ->where('so.tanggal_keluar <=', $endDT);

        if (!empty($productId)) {
            $bTop->where('p.id', (int) $productId);
        }
        if (!empty($brandId)) {
            $bTop->where('p.brand_id', (int) $brandId);
        }
        if (!empty($categoryId)) {
            $bTop->where('p.category_id', (int) $categoryId);
        }

        $topProducts = $bTop->groupBy('p.id')
            ->orderBy('total', 'DESC')
            ->limit(10)
            ->get()->getResultArray();

        // ------------- Low Stock Products -------------
        $bLow = $this->db->table('tb_products p')
            ->select('p.id, p.nama_barang, p.image, p.stok_saat_ini, p.min_stok')
            ->where('p.stok_saat_ini <= p.min_stok');

        if (!empty($productId)) {
            $bLow->where('p.id', (int) $productId);
        }
        if (!empty($brandId)) {
            $bLow->where('p.brand_id', (int) $brandId);
        }
        if (!empty($categoryId)) {
            $bLow->where('p.category_id', (int) $categoryId);
        }

        $lowStock = $bLow->orderBy('p.stok_saat_ini', 'ASC')
            ->limit(10)
            ->get()->getResultArray();

        // ------------- Donut Charts (Proportion of Stock) -------------
        // by product
        $bDonutProduct = $this->db->table('tb_products p')
            ->select('p.nama_barang AS label')
            ->select('SUM(p.stok_saat_ini) AS value', false);

        if (!empty($productId)) {
            $bDonutProduct->where('p.id', (int) $productId);
        }
        if (!empty($brandId)) {
            $bDonutProduct->where('p.brand_id', (int) $brandId);
        }
        if (!empty($categoryId)) {
            $bDonutProduct->where('p.category_id', (int) $categoryId);
        }

        $donutByProduct = $bDonutProduct->groupBy('p.id')
            ->orderBy('value', 'DESC')
            ->limit(20)
            ->get()->getResultArray();

        // by brand
        $bDonutBrand = $this->db->table('tb_products p')
            ->join('tb_brands b', 'b.id = p.brand_id', 'left')
            ->select("COALESCE(b.nama_brand, 'No Brand') AS label", false)
            ->select('SUM(p.stok_saat_ini) AS value', false);

        if (!empty($productId)) {
            $bDonutBrand->where('p.id', (int) $productId);
        }
        if (!empty($brandId)) {
            $bDonutBrand->where('p.brand_id', (int) $brandId);
        }
        if (!empty($categoryId)) {
            $bDonutBrand->where('p.category_id', (int) $categoryId);
        }

        $donutByBrand = $bDonutBrand->groupBy('p.brand_id')
            ->orderBy('value', 'DESC')
            ->get()->getResultArray();

        // by category
        $bDonutCategory = $this->db->table('tb_products p')
            ->join('tb_categories c', 'c.id = p.category_id', 'left')
            ->select("COALESCE(c.nama_kategori, 'No Category') AS label", false)
            ->select('SUM(p.stok_saat_ini) AS value', false);

        if (!empty($productId)) {
            $bDonutCategory->where('p.id', (int) $productId);
        }
        if (!empty($brandId)) {
            $bDonutCategory->where('p.brand_id', (int) $brandId);
        }
        if (!empty($categoryId)) {
            $bDonutCategory->where('p.category_id', (int) $categoryId);
        }

        $donutByCategory = $bDonutCategory->groupBy('p.category_id')
            ->orderBy('value', 'DESC')
            ->get()->getResultArray();

        // ------------- WORKSHOP SECTION -------------

        // 1. Active Work Orders (status = 'Proses')
        $bActiveWO = $this->db->table('tb_stock_out so')
            ->where('so.status', 'Proses')
            ->where('so.tanggal_keluar >=', $startDT)
            ->where('so.tanggal_keluar <=', $endDT)
            ->countAllResults();

        // 2. Total Completed Services
        $bCompletedServices = $this->db->table('tb_stock_out_services sos')
            ->join('tb_stock_out so', 'so.id = sos.stock_out_id', 'inner')
            ->where('so.status', 'Selesai')
            ->where('so.tanggal_keluar >=', $startDT)
            ->where('so.tanggal_keluar <=', $endDT)
            ->countAllResults();

        // 3. Top Services by Frequency
        $bTopServices = $this->db->table('tb_stock_out_services sos')
            ->join('tb_stock_out so', 'so.id = sos.stock_out_id', 'inner')
            ->join('tb_services s', 's.id = sos.service_id', 'inner')
            ->select('s.nama_service AS service_name')
            ->select('COUNT(sos.id) AS frequency', false)
            ->select('SUM(sos.biaya_jasa * sos.jumlah) AS total_revenue', false)
            ->where('so.tanggal_keluar >=', $startDT)
            ->where('so.tanggal_keluar <=', $endDT)
            ->groupBy('s.id')
            ->orderBy('frequency', 'DESC')
            ->limit(10)
            ->get()->getResultArray();

        // ------------- FINANCIAL SECTION -------------

        // 1. Total Purchase Value (Stock In)
        $bPurchaseValue = $this->db->table('tb_stock_in_items sii')
            ->join('tb_stock_in si', 'si.id = sii.stock_in_id', 'inner')
            ->select('SUM(sii.jumlah * sii.harga_beli_satuan) AS total', false)
            ->where('si.tanggal_masuk >=', $startDT)
            ->where('si.tanggal_masuk <=', $endDT);

        if (!empty($productId) || !empty($brandId) || !empty($categoryId)) {
            $bPurchaseValue->join('tb_products p', 'p.id = sii.product_id', 'inner');
            $applyProductFilter($bPurchaseValue, 'p', true);
        }

        $rowPurchase = $bPurchaseValue->get()->getRowArray();
        $totalPurchaseValue = (float) ($rowPurchase['total'] ?? 0);

        // 2. Total Revenue (Stock Out)
        $bRevenue = $this->db->table('tb_stock_out_items soi')
            ->join('tb_stock_out so', 'so.id = soi.stock_out_id', 'inner')
            ->select('SUM(soi.jumlah * soi.harga_jual_satuan) AS total', false)
            ->where('so.tanggal_keluar >=', $startDT)
            ->where('so.tanggal_keluar <=', $endDT);

        if (!empty($productId) || !empty($brandId) || !empty($categoryId)) {
            $bRevenue->join('tb_products p', 'p.id = soi.product_id', 'inner');
            $applyProductFilter($bRevenue, 'p', true);
        }

        $rowRevenue = $bRevenue->get()->getRowArray();
        $totalRevenue = (float) ($rowRevenue['total'] ?? 0);

        // 3. Total Profit (Revenue - Cost)
        $bProfit = $this->db->table('tb_stock_out_items soi')
            ->join('tb_stock_out so', 'so.id = soi.stock_out_id', 'inner')
            ->select('SUM(soi.jumlah * (soi.harga_jual_satuan - soi.harga_beli_satuan)) AS total', false)
            ->where('so.tanggal_keluar >=', $startDT)
            ->where('so.tanggal_keluar <=', $endDT);

        if (!empty($productId) || !empty($brandId) || !empty($categoryId)) {
            $bProfit->join('tb_products p', 'p.id = soi.product_id', 'inner');
            $applyProductFilter($bProfit, 'p', true);
        }

        $rowProfit = $bProfit->get()->getRowArray();
        $totalProfit = (float) ($rowProfit['total'] ?? 0);

        // 4. Inventory Value (Current Stock Value - not date filtered)
        $bInventoryValue = $this->db->table('tb_products p')
            ->join('tb_stock_in_items sii', 'sii.product_id = p.id', 'left')
            ->select('p.id, p.stok_saat_ini')
            ->select('COALESCE(AVG(sii.harga_beli_satuan), 0) AS avg_cost', false)
            ->groupBy('p.id');

        if (!empty($productId)) {
            $bInventoryValue->where('p.id', (int) $productId);
        }
        if (!empty($brandId)) {
            $bInventoryValue->where('p.brand_id', (int) $brandId);
        }
        if (!empty($categoryId)) {
            $bInventoryValue->where('p.category_id', (int) $categoryId);
        }

        $inventoryRows = $bInventoryValue->get()->getResultArray();
        $inventoryValue = 0;
        foreach ($inventoryRows as $row) {
            $inventoryValue += (float) $row['stok_saat_ini'] * (float) $row['avg_cost'];
        }

        $financialCards = [
            'inventory_value'     => $inventoryValue,
            'total_purchase_value' => $totalPurchaseValue,
            'total_revenue'       => $totalRevenue,
            'total_profit'        => $totalProfit,
        ];

        // ------------- CHART 1: Profit vs Revenue Trend (Daily) -------------
        $bProfitRevenueTrend = $this->db->table('tb_stock_out so')
            ->join('tb_stock_out_items soi', 'soi.stock_out_id = so.id', 'inner')
            ->select("DATE(so.tanggal_keluar) AS tanggal", false)
            ->select('SUM(soi.jumlah * soi.harga_jual_satuan) AS revenue', false)
            ->select('SUM(soi.jumlah * (soi.harga_jual_satuan - soi.harga_beli_satuan)) AS profit', false)
            ->where('so.tanggal_keluar >=', $startDT)
            ->where('so.tanggal_keluar <=', $endDT);

        if (!empty($productId) || !empty($brandId) || !empty($categoryId)) {
            $bProfitRevenueTrend->join('tb_products p', 'p.id = soi.product_id', 'inner');
            $applyProductFilter($bProfitRevenueTrend, 'p', true);
        }

        $profitRevenueTrendRows = $bProfitRevenueTrend->groupBy('DATE(so.tanggal_keluar)')
            ->orderBy('tanggal', 'ASC')
            ->get()->getResultArray();

        $profitRevenueTrend = [];
        foreach ($profitRevenueTrendRows as $r) {
            $profitRevenueTrend[] = [
                'tanggal' => $r['tanggal'],
                'revenue' => (float) ($r['revenue'] ?? 0),
                'profit'  => (float) ($r['profit'] ?? 0),
            ];
        }

        // ------------- CHART 2: Revenue by Category (Donut) -------------
        $bRevenueByCategory = $this->db->table('tb_stock_out_items soi')
            ->join('tb_stock_out so', 'so.id = soi.stock_out_id', 'inner')
            ->join('tb_products p', 'p.id = soi.product_id', 'inner')
            ->join('tb_categories c', 'c.id = p.category_id', 'left')
            ->select("COALESCE(c.nama_kategori, 'No Category') AS category_name", false)
            ->select('SUM(soi.jumlah * soi.harga_jual_satuan) AS value', false)
            ->where('so.tanggal_keluar >=', $startDT)
            ->where('so.tanggal_keluar <=', $endDT);

        if (!empty($productId)) {
            $bRevenueByCategory->where('p.id', (int) $productId);
        }
        if (!empty($brandId)) {
            $bRevenueByCategory->where('p.brand_id', (int) $brandId);
        }
        if (!empty($categoryId)) {
            $bRevenueByCategory->where('p.category_id', (int) $categoryId);
        }

        $revenueByCategory = $bRevenueByCategory->groupBy('p.category_id')
            ->orderBy('value', 'DESC')
            ->get()->getResultArray();

        // ------------- CHART 3: Sales Velocity (Average Days to Sell) -------------
        // Calculate average days between stock in and stock out for each product
        $bSalesVelocity = $this->db->query("
            SELECT 
                p.nama_barang AS product_name,
                COALESCE(AVG(DATEDIFF(so.tanggal_keluar, si.tanggal_masuk)), 0) AS avg_days_to_sell
            FROM tb_stock_out_items soi
            INNER JOIN tb_stock_out so ON so.id = soi.stock_out_id
            INNER JOIN tb_products p ON p.id = soi.product_id
            LEFT JOIN tb_stock_in_items sii ON sii.product_id = p.id
            LEFT JOIN tb_stock_in si ON si.id = sii.stock_in_id
            WHERE so.tanggal_keluar >= ? AND so.tanggal_keluar <= ?
            " . (!empty($productId) ? " AND p.id = " . (int) $productId : "") . "
            " . (!empty($brandId) ? " AND p.brand_id = " . (int) $brandId : "") . "
            " . (!empty($categoryId) ? " AND p.category_id = " . (int) $categoryId : "") . "
            GROUP BY p.id
            ORDER BY avg_days_to_sell ASC
            LIMIT 10
        ", [$startDT, $endDT]);

        $salesVelocity = $bSalesVelocity->getResultArray();

        // ------------- CHART 4: Top 10 High Margin Products -------------
        $bTopMargin = $this->db->table('tb_stock_out_items soi')
            ->join('tb_stock_out so', 'so.id = soi.stock_out_id', 'inner')
            ->join('tb_products p', 'p.id = soi.product_id', 'inner')
            ->select('p.nama_barang AS product_name')
            ->select('AVG(((soi.harga_jual_satuan - soi.harga_beli_satuan) / soi.harga_beli_satuan) * 100) AS margin_percentage', false)
            ->where('so.tanggal_keluar >=', $startDT)
            ->where('so.tanggal_keluar <=', $endDT)
            ->where('soi.harga_beli_satuan >', 0);

        if (!empty($productId)) {
            $bTopMargin->where('p.id', (int) $productId);
        }
        if (!empty($brandId)) {
            $bTopMargin->where('p.brand_id', (int) $brandId);
        }
        if (!empty($categoryId)) {
            $bTopMargin->where('p.category_id', (int) $categoryId);
        }

        $topMarginProducts = $bTopMargin->groupBy('p.id')
            ->orderBy('margin_percentage', 'DESC')
            ->limit(10)
            ->get()->getResultArray();

        $payload = [
            'cards'              => $cards,
            'overview_chart'     => $overview,
            'top_products_chart' => $topProducts,
            'low_stock_products' => $lowStock,
            'donut_charts'       => [
                'product'  => $donutByProduct,
                'brand'    => $donutByBrand,
                'category' => $donutByCategory,
            ],
            // Financial section
            'financial_cards'         => $financialCards,
            'profit_revenue_trend'    => $profitRevenueTrend,
            'revenue_by_category'     => $revenueByCategory,
            'sales_velocity'          => $salesVelocity,
            'top_margin_products'     => $topMarginProducts,
        ];

        return $this->response->setJSON($payload);
    }
}
